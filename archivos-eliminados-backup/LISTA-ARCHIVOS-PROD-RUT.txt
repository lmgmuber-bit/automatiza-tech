â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  LISTA DE ARCHIVOS PARA SUBIR A PRODUCCIÃ“N - RUT EN FACTURAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… Fecha: 2025-11-16
ğŸ¯ Objetivo: RUT en facturas + Ocultar botones + ValidaciÃ³n RUT inline

âš ï¸ ORDEN CRÃTICO: Base de Datos PRIMERO, Archivos DESPUÃ‰S

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ—„ï¸ PASO 1: BASE DE DATOS (EJECUTAR PRIMERO EN PRODUCCIÃ“N)

CRÃTICO: Ejecutar este SQL ANTES de subir archivos:

-- Agregar campo tax_id a tabla clients (clientes)
ALTER TABLE clients 
ADD COLUMN IF NOT EXISTS tax_id VARCHAR(20) NULL AFTER country;

-- Verificar que se creÃ³ correctamente
SHOW COLUMNS FROM clients LIKE 'tax_id';

âš ï¸ NO CONTINUAR hasta confirmar que el campo existe

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… PASO 2: ARCHIVOS A SUBIR (DESPUÃ‰S DEL PASO 1)

1. wp-content/themes/automatiza-tech/inc/contact-form.php
   â””â”€ ValidaciÃ³n RUT inline, campo tax_id, botones ocultos

2. clear-rate-limit.php
   â””â”€ Script para limpiar lÃ­mite de intentos (NUEVO archivo en raÃ­z)

NOTA IMPORTANTE:
   âœ… invoice-pdf-fpdf.php YA estÃ¡ correcto en PROD (verificado lÃ­nea 302)
   âŒ NO es necesario subirlo de nuevo

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ PASO 3: PASOS DE DESPLIEGUE

1. BACKUP (Siempre primero)
   âœ“ Hacer backup completo del sitio
   âœ“ Backup de base de datos

2. BASE DE DATOS (CrÃ­tico)
   âœ“ Conectar a phpMyAdmin de Hostinger
   âœ“ Ejecutar: ALTER TABLE clients ADD COLUMN...
   âœ“ Verificar: SHOW COLUMNS FROM clients LIKE 'tax_id';
   âœ“ CONFIRMAR que el campo existe antes de continuar

3. SUBIR ARCHIVOS (Solo despuÃ©s de verificar BD)
   âœ“ Subir contact-form.php a /wp-content/themes/automatiza-tech/inc/
   âœ“ Subir clear-rate-limit.php a raÃ­z del sitio /
   âœ— NO subir invoice-pdf-fpdf.php (ya estÃ¡ correcto en PROD)

4. PROBAR FUNCIONAMIENTO
   âœ“ Ir a: https://automatizatech.shop/#contacto
   âœ“ Ingresar RUT: 261918072 (debe formatear a 26191807-2)
   âœ“ Enviar formulario y verificar que se guarda
   âœ“ Crear factura de un cliente
   âœ“ VERIFICAR que el RUT aparece en "DATOS DEL CLIENTE"
   âœ“ Verificar que botÃ³n "Regenerar Facturas" estÃ¡ oculto

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ PROBLEMA: "LA FACTURA NO MUESTRA EL RUT"

CAUSA: El campo tax_id no existe en la tabla clients

SOLUCIÃ“N: Ejecutar en phpMyAdmin:
ALTER TABLE clients ADD COLUMN IF NOT EXISTS tax_id VARCHAR(20) NULL AFTER country;

VERIFICAR: 
SHOW COLUMNS FROM clients LIKE 'tax_id';

Si el campo ya existe pero no se muestra:
â€¢ Verificar que el cliente tiene tax_id guardado en BD
â€¢ Regenerar la factura del cliente
â€¢ Revisar lÃ­nea 302 de invoice-pdf-fpdf.php (debe tener: $this->client_data->tax_id)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” TROUBLESHOOTING:

â€¢ "Error al guardar el mensaje" â†’ Falta campo tax_id en BD
â€¢ "Has excedido el lÃ­mite" â†’ Ejecutar clear-rate-limit.php
â€¢ RUT no valida en tiempo real â†’ Limpiar cachÃ© del navegador
â€¢ Factura sin RUT â†’ Ver soluciÃ³n arriba

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ VERIFICACIÃ“N RÃPIDA EN BD:

-- Ver estructura de tabla clients
DESCRIBE clients;

-- Ver RUTs guardados en clientes
SELECT id, name, email, tax_id FROM clients 
WHERE tax_id IS NOT NULL 
ORDER BY id DESC LIMIT 10;

-- Actualizar RUT manualmente (ejemplo)
UPDATE clients SET tax_id = '26191807-2' WHERE id = 1;

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… RESULTADO ESPERADO:

DespuÃ©s del despliegue correcto:
âœ“ Campo tax_id existe en tabla clients
âœ“ Formulario valida RUT en tiempo real (verde/rojo)
âœ“ RUT se guarda con formato correcto (12345678-9)
âœ“ Facturas PDF muestran el RUT en "DATOS DEL CLIENTE"
âœ“ BotÃ³n "Regenerar Facturas" estÃ¡ oculto en panel admin
âœ“ Rate limiting funciona (mÃ¡x 3 envÃ­os por hora)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ NOTAS FINALES:

â€¢ invoice-pdf-fpdf.php YA tiene el cÃ³digo correcto (lÃ­nea 302)
â€¢ Solo falta agregar el campo tax_id a la tabla clients
â€¢ Una vez agregado, las nuevas facturas mostrarÃ¡n el RUT
â€¢ Para clientes antiguos, actualizar manualmente el campo tax_id

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ãšltima actualizaciÃ³n: 16 de Noviembre 2025
VersiÃ³n: 3.0 - Fix Factura + ValidaciÃ³n RUT Inline
Estado: invoice-pdf-fpdf.php verificado correcto en PROD

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
